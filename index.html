<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>BocheCrawler v0.5 ‚Äî Caves, Beasts, Shops</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg:#0b0b0c; --panel:#121215; --ink:#e7e3da; --muted:#a7a39a; --accent:#d84f4f; --gold:#c09b43; --good:#58c97c; --bad:#d45b5b; --blue:#4fa3d8; --vio:#7a5bd4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 50% -200px,#15151a,#0b0b0c);color:var(--ink);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex; align-items:center; justify-content:center;}
    #game{width:100%; max-width:560px; height:100svh; background:linear-gradient(180deg,#0b0b0c 0%, #0e0e10 40%, #111116 100%);
      border:1px solid #222; border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.6); overflow-y:auto; -webkit-overflow-scrolling:touch; position:relative}
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0f0f12; border-bottom:1px solid #1f1f24; position:sticky; top:0; z-index:5}
    .title{font-weight:800; letter-spacing:.2px; font-size:14px}
    .pill{padding:3px 6px; border:1px solid #333; border-radius:999px; font-size:11px; color:var(--muted)}
    .btn{background:#1a1a20;color:var(--ink);border:1px solid #2a2a33;padding:8px 10px;border-radius:12px;font-weight:700;font-size:12px;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .arena{display:grid; grid-template-rows: 168px auto auto; gap:10px; padding:10px 12px}
    .stage{display:grid; grid-template-columns: 1fr; gap:8px; background:#0e0e12; border:1px solid #24242a; border-radius:16px; padding:10px}
    .stageTop{display:flex; align-items:center; justify-content:space-between}
    .enemyBox{display:flex; align-items:center; gap:10px}
    .sprite{height:84px; width:84px; border-radius:10px; background:repeating-linear-gradient(90deg,#120c0c 0 4px,#150e0e 4px 8px); border:1px solid #23232b; display:flex; align-items:center; justify-content:center; font-size:28px; position:relative}
    .hpWrap{flex:1}
    .hpbar{position:relative; height:14px; background:#1a1a20; border:1px solid #2a2a33; border-radius:999px; overflow:hidden}
    .hpfill{position:absolute; inset:0; width:100%; background:linear-gradient(90deg, #e87070, #b14040)}
    .hud{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .stat{font-size:12px; color:var(--muted)}

    .panel{background:var(--panel); border:1px solid #24242a; border-radius:16px; padding:10px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .col{display:flex; flex-direction:column; gap:8px}

    /* Joker bar */
    .jokers{display:flex; gap:10px; overflow-x:auto; padding:8px 6px; background:#101015; border-radius:12px; scroll-snap-type:x mandatory}
    .joker{width:150px; flex:0 0 auto; background:#141419; border:1px solid #2a2a33; border-radius:14px; padding:10px; scroll-snap-align:start}
    .joker h4{margin:0 0 2px 0; font-size:12px; color:var(--muted)}
    .pip{font-size:26px; font-weight:800}
    .meta{font-size:11px; color:var(--muted)}
    .joker.echo{outline:1px dashed var(--gold); box-shadow:0 0 10px rgba(192,155,67,.25)}

    /* Cards hand */
    .handWrap{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
    .hand{display:flex; gap:8px; overflow-x:auto; padding:6px 4px; min-height:98px}
    .card{min-width:160px; background:#141419; border:1px solid #2a2a33; border-radius:14px; padding:10px; text-align:left}
    .card .name{font-weight:700; font-size:13px}
    .card .desc{font-size:11px; color:var(--muted)}

    .log{max-height:160px; overflow:auto; font-size:12px; line-height:1.35; color:var(--muted); border-top:1px dashed #2a2a33; padding-top:6px}

    /* Modals */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding:16px; z-index:20}
    .modal{background:#131318; border:1px solid #2a2a33; border-radius:16px; width:100%; max-width:460px; padding:12px}
    .modal h3{margin:0 0 6px 0}
    .choices{display:grid; grid-template-columns:1fr; gap:8px}
    .choice{background:#15151b; border:1px solid #2a2a33; border-radius:12px; padding:10px; text-align:left}
    .choice .row{align-items:start}
    .price{font-weight:800}
    .rar{font-weight:800}
    .rar.common{color:#bbb}
    .rar.uncommon{color:#79b7f2}
    .rar.rare{color:#b699ff}
    .rar.mythic{color:#ffd166}
  </style>
</head>
<body>
  <div id="game">
    <div class="topbar">
      <div class="title">BocheCrawler v0.5 ‚Äî Caves & Beasts</div>
      <div class="hud">
        <span class="pill">Cave <b id="cave">1</b></span>
        <span class="pill">Beast <b id="beast">1/3</b></span>
        <span class="pill">Hands <b id="hands">4</b></span>
        <span class="pill">Teeth ü¶∑ <b id="teeth">0</b></span>
        <span class="pill">Energy <b id="energy">3</b></span>
        <button class="btn" id="btnNew">New Run</button>
      </div>
    </div>

    <div class="arena">
      <div class="stage">
        <div class="stageTop">
          <div class="enemyBox">
            <div class="sprite" id="enemySprite">ü©∏</div>
            <div class="hpWrap">
              <div class="row" style="margin-bottom:4px">
                <div class="stat"><b id="enemyName">Scout Beast</b></div>
                <div class="stat">Omen: <b id="beastMod">‚Äî</b></div>
              </div>
              <div class="hpbar"><div class="hpfill" id="enemyHPFill"></div></div>
              <div class="stat">HP <b id="enemyHP">50</b> / <b id="enemyHPMax">50</b></div>
            </div>
          </div>
          <div class="col">
            <div class="stat">Gravegrit: <b id="grit">0</b> ‚Ä¢ Oathfire: <b id="oath">0</b>x</div>
            <div class="row">
              <button class="btn" id="btnRoll">Roll</button>
              <button class="btn" id="btnResolve" disabled>Resolve</button>
              <button class="btn" id="btnEndHand" disabled>End Hand</button>
              <button class="btn" id="btnAddEcho">+Echo Die</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="margin-bottom:6px">
          <div class="stat">Dice (Jokers)</div>
          <div class="stat">Rerolls <b id="rerolls">1</b></div>
        </div>
        <div class="jokers" id="diceTray"></div>
      </div>

      <div class="panel">
        <div class="handWrap">
          <div class="stat">Hand</div>
          <div class="stat">Draw pile <b id="drawCount">0</b></div>
        </div>
        <div class="hand" id="hand"></div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

  <!-- Shop modal -->
  <div class="overlay" id="shop">
    <div class="modal">
      <h3>Burrow-Market</h3>
      <div class="stat">Spend your <b>Teeth</b> to grow stronger.</div>
      <div class="choices" id="shopChoices"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnSkipShop">Leave</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const L = (m)=>{ const p=document.createElement('p'); p.textContent=m; $('log').prepend(p); };
  const R = (n)=>Math.floor(Math.random()*n);
  const pick = (a)=>a[R(a.length)];
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function clone(x){ return JSON.parse(JSON.stringify(x)); }

  // ===== Boche Terms / Data =====
  const FACE = { SWORD:{k:'SWORD', i:'‚öîÔ∏è'}, SHIELD:{k:'SHIELD', i:'üõ°Ô∏è'}, EYE:{k:'EYE', i:'üëÅÔ∏è'}, HEX:{k:'HEX', i:'‚ò†Ô∏è'}, WILD:{k:'WILD', i:'‚≠ê'} };

  // Dice rarities and pool
  const RAR = { COMMON:'common', UNCOMMON:'uncommon', RARE:'rare', MYTHIC:'mythic', ECHO:'echo' };

  const DICE_POOL = [
    // Common
    {name:'Initiate Die', faces:[FACE.SWORD,FACE.SWORD,FACE.SHIELD,FACE.EYE,FACE.WILD,FACE.SHIELD], power:1, affix:RAR.COMMON, echo:false, effect:{type:'fury_per_eye', v:0.25}},
    {name:'Stitched Cube', faces:[FACE.SWORD,FACE.SHIELD,FACE.SHIELD,FACE.EYE,FACE.SWORD,FACE.SHIELD], power:1, affix:RAR.COMMON, echo:false, effect:{type:'flat_grit', v:6}},
    // Uncommon
    {name:'Omen-Carved', faces:[FACE.SWORD,FACE.SWORD,FACE.HEX,FACE.SWORD,FACE.EYE,FACE.HEX], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'grit_on_hex', v:8}},
    {name:'Blessed Cube', faces:[FACE.SWORD,FACE.WILD,FACE.SHIELD,FACE.EYE,FACE.SWORD,FACE.SHIELD], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'flat_fury', v:0.2}},
    {name:'Rot Die', faces:[FACE.HEX,FACE.SWORD,FACE.HEX,FACE.SHIELD,FACE.EYE,FACE.HEX], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'reduce_maxhp_on_hex', v:5}},
    // Rare
    {name:'Bone Fracture', faces:[FACE.SWORD,FACE.SWORD,FACE.SWORD,FACE.EYE,FACE.WILD,FACE.SHIELD], power:2, affix:RAR.RARE, echo:false, effect:{type:'fury_per_sword', v:0.4}},
    {name:'Gilded Jaw', faces:[FACE.SWORD,FACE.EYE,FACE.SHIELD,FACE.SWORD,FACE.WILD,FACE.SHIELD], power:2, affix:RAR.RARE, echo:false, effect:{type:'teeth_on_resolve', v:2}},
    // Mythic
    {name:'Hollow Face', faces:[FACE.WILD,FACE.SWORD,FACE.WILD,FACE.SWORD,FACE.WILD,FACE.SWORD], power:3, affix:RAR.MYTHIC, echo:false, effect:{type:'sword_amp_but_hand_penalty', v:0.5}},
    // Echo (Spectral)
    {name:'Wraith Echo', faces:[FACE.WILD,FACE.SWORD,FACE.EYE,FACE.HEX,FACE.WILD,FACE.SWORD], power:2, affix:RAR.ECHO, echo:true, effect:{type:'fury_per_wild', v:0.5}},
  ];

  // Cards
  const CARD_DB = {
    'Bone Toss': {cost:1, text:'+10 Gravegrit, draw 1', play:G=>{G.turn.grit+=10; G.turn.drawNext=1;}},
    'Mire Shield': {cost:1, text:'+15 Gravegrit & lower enemy DR by 10% this hand', play:G=>{G.turn.grit+=15; G.turn.lowerDR=0.10;}},
    'Blood Pledge': {cost:1, text:'Lose 10 HP, +0.6 Oathfire this hand', play:G=>{G.turn.oath+=0.6;}},
    'Oathbound Strike': {cost:1, text:'+20 Gravegrit; double Fury from dice this hand', play:G=>{G.turn.grit+=20; G.turn.doubleFury=true;}},
    'Lunge': {cost:1, text:'+20 Gravegrit', play:G=>{G.turn.grit+=20;}},
    'Guard': {cost:1, text:'+10 Gravegrit & +1 reroll', play:G=>{G.turn.grit+=10; G.turn.rerolls++;}},
    'Hex Canticle': {cost:1, text:'Tag HEX (synergy with ‚ò†Ô∏è)', play:G=>{G.turn.tags.add('HEX_TAG');}},
    'Focus': {cost:1, text:'+0.3 Oathfire', play:G=>{G.turn.oath+=0.3;}},
    'Convert': {cost:1, text:'Turn one üõ°Ô∏è to ‚öîÔ∏è this hand', play:G=>{const d=G.dice.find(d=>d.current && d.current.k==='SHIELD'); if(d){ d.current=FACE.SWORD; L('A shield becomes a blade.'); }}},
  };
  function starterDeck(){ return ['Lunge','Lunge','Lunge','Guard','Guard','Hex Canticle','Focus','Convert','Bone Toss','Mire Shield']; }

  // Beasts per Cave
  const BEASTS=[
    {name:'Scout Beast', omen:'None', hp:(c)=> 40 + (c-1)*20},
    {name:'Mire Beast', omen:'Thick Hide (+10% DR)', hp:(c)=> 65 + (c-1)*30, rule:(G)=>{G.enemy.dr=0.10;}},
    {name:'Crypt Lord', omen:'Dread Sigil (+Hex burden per resolve)', hp:(c)=> 90 + (c-1)*45, rule:(G)=>{G.enemy.onResolveHex=1;}},
  ];
  const ENEMY_SPRITES=['ü©∏','ü¶¥','üê∫','üïØÔ∏è','üó°Ô∏è','üï∑Ô∏è'];

  // Shop config
  const SHOP = {
    cardPackCost: 12,
    singleCardCost: 6,
    diceBagCost: 20,
    perCaveDiceBagLimit: 1,
  };

  // Teeth rewards per beast
  const TEETH_REWARD = [8, 12, 20];

  // ===== Game State =====
  const G = {
    cave:1, beastIndex:0,
    handsMax:4, hands:4,
    teeth:0,
    energy:3, baseEnergy:3,
    dice:[], hand:[], draw:[], discard:[],
    enemy:{name:'', hp:0, hpMax:0, dr:0, onResolveHex:0, sprite:'ü©∏'},
    turn:{grit:0, oath:0, rerolls:1, tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0},
    caveDiceBagsBought:0
  };

  // ===== UI Refs =====
  const refs={
    cave:$('cave'), beast:$('beast'), hands:$('hands'), teeth:$('teeth'), energy:$('energy'),
    enemySprite:$('enemySprite'), enemyName:$('enemyName'), beastMod:$('beastMod'),
    enemyHP:$('enemyHP'), enemyHPMax:$('enemyHPMax'), enemyHPFill:$('enemyHPFill'),
    diceTray:$('diceTray'), hand:$('hand'), drawCount:$('drawCount'),
    grit:$('grit'), oath:$('oath'), rerolls:$('rerolls'),
    btnRoll:$('btnRoll'), btnResolve:$('btnResolve'), btnEndHand:$('btnEndHand'), btnAddEcho:$('btnAddEcho'),
    shop:$('shop'), shopChoices:$('shopChoices'), btnSkipShop:$('btnSkipShop')
  };

  // ===== Setup / Flow =====
  function newRun(){
    G.cave=1; G.beastIndex=0; G.handsMax=4; G.energy=G.baseEnergy=3; G.teeth=0; G.caveDiceBagsBought=0;
    G.dice=[ clone(pickByRarity(['common','uncommon'])), clone(pickByRarity(['common'])), clone(pickByRarity(['uncommon'])) ];
    G.draw=shuffle(starterDeck()); G.discard=[]; G.hand=[];
    startBeast();
    L('‚Äî New run. The cave yawns open. ‚Äî');
  }

  function startBeast(){
    G.hands=G.handsMax;
    const b=BEASTS[G.beastIndex];
    const hp=b.hp(G.cave);
    Object.assign(G.enemy,{name:b.name, hp:hp, hpMax:hp, dr:0, onResolveHex:0, sprite:pick(ENEMY_SPRITES)});
    if(b.rule) b.rule(G);
    G.turn={grit:0,oath:0,rerolls:1,tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0};
    updateUI();
    drawCards(3);
    renderDice();
    L(`‚Äî ${b.name} (Cave ${G.cave}) ‚Äî ${b.omen}`);
  }

  function updateUI(){
    refs.cave.textContent=G.cave;
    refs.beast.textContent=(G.beastIndex+1)+'/3';
    refs.hands.textContent=G.hands;
    refs.teeth.textContent=G.teeth;
    refs.energy.textContent=G.energy;
    refs.rerolls.textContent=G.turn.rerolls;
    $('grit').textContent=Math.round(G.turn.grit);
    $('oath').textContent=(G.turn.oath).toFixed(2);
    refs.enemyName.textContent=G.enemy.name;
    refs.enemyHP.textContent=G.enemy.hp; refs.enemyHPMax.textContent=G.enemy.hpMax;
    refs.enemyHPFill.style.width=(G.enemy.hp/G.enemy.hpMax*100)+'%';
    refs.enemySprite.textContent=G.enemy.sprite;
    refs.beastMod.textContent=BEASTS[G.beastIndex].omen;
    refs.drawCount.textContent=G.draw.length;
  }

  // ===== Dice & Cards =====
  function pickByRarity(allowed){
    const pool = DICE_POOL.filter(d=>allowed.includes(d.affix));
    return pick(pool);
  }

  function renderDice(){
    refs.diceTray.innerHTML='';
    G.dice.forEach((d,idx)=>{
      const el=document.createElement('div'); el.className='joker'+(d.echo?' echo':'');
      const h4=document.createElement('h4'); h4.textContent=d.name; el.appendChild(h4);
      const face=document.createElement('div'); face.className='pip'; face.textContent=d.current?d.current.i:'‚Äî'; el.appendChild(face);
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<span class="rar ${d.affix}">${labelRarity(d.affix)}</span> ‚Ä¢ eff ${d.effect.type}`;
      el.appendChild(meta);
      el.addEventListener('click',()=>{ G.selDie=idx; });
      refs.diceTray.appendChild(el);
    });
  }
  function labelRarity(r){ return r.charAt(0).toUpperCase()+r.slice(1); }

  function renderHand(){
    refs.hand.innerHTML='';
    if(!G.hand.length){ const tip=document.createElement('div'); tip.className='stat'; tip.style.padding='4px'; tip.textContent='(No cards in hand)'; refs.hand.appendChild(tip); return; }
    G.hand.forEach((name,i)=>{
      const def=CARD_DB[name];
      const btn=document.createElement('button'); btn.className='card';
      btn.innerHTML=`<div class="name">${name} <span class="pill">${def.cost}</span></div><div class="desc">${def.text}</div>`;
      btn.disabled=(G.energy<def.cost);
      btn.addEventListener('click',()=> playCard(i));
      refs.hand.appendChild(btn);
    });
  }

  function drawCards(n){
    for(let i=0;i<n;i++){
      if(G.draw.length===0){ G.draw=shuffle(G.discard); G.discard=[]; }
      if(G.draw.length===0) break;
      G.hand.push(G.draw.pop());
      if(G.turn.drawNext>0){ G.turn.drawNext--; }
    }
    updateUI(); renderHand();
  }

  // ===== Turn Flow =====
  function rollDice(){
    if(G.turn.rerolls<=0){ L('No rerolls left.'); return; }
    // roll dice
    let turnFuryBonus=0, turnGritBonus=0;
    G.dice.forEach(d=>{
      const idx=R(d.faces.length); d.current=d.faces[idx];
      // apply die effects
      if(d.effect?.type==='fury_per_eye' && d.current.k==='EYE'){ turnFuryBonus += d.effect.v; }
      if(d.effect?.type==='fury_per_wild' && d.current.k==='WILD'){ turnFuryBonus += d.effect.v; }
      if(d.effect?.type==='flat_fury'){ turnFuryBonus += d.effect.v; }
      if(d.effect?.type==='fury_per_sword' && d.current.k==='SWORD'){ turnFuryBonus += d.effect.v; }
      if(d.effect?.type==='flat_grit'){ turnGritBonus += d.effect.v; }
      if(d.effect?.type==='grit_on_hex' && (d.current.k==='HEX' || G.turn.tags.has('HEX_TAG')) ){ turnGritBonus += d.effect.v; }
      if(d.effect?.type==='reduce_maxhp_on_hex' && d.current.k==='HEX'){ G.enemy.hpMax = Math.max(1, G.enemy.hpMax - d.effect.v); G.enemy.hp = Math.min(G.enemy.hp, G.enemy.hpMax); }
      if(d.effect?.type==='sword_amp_but_hand_penalty' && d.current.k==='SWORD'){ turnGritBonus += Math.round( (G.turn.grit+turnGritBonus) * d.effect.v ); }
    });
    G.turn.oath += (G.turn.doubleFury? turnFuryBonus*2 : turnFuryBonus);
    G.turn.grit += turnGritBonus;
    G.turn.rerolls--;
    refs.btnResolve.disabled=false;
    updateUI(); renderDice();
    L(`You roll. +${Math.round(turnGritBonus)} Gravegrit, +${turnFuryBonus.toFixed(2)} Oathfire.`);
  }

  function resolveHand(){
    // calculate damage
    const mult = 1 + G.turn.oath;
    let dmg = Math.round( G.turn.grit * mult );
    // apply lowerDR card effect
    const dr = clamp( (G.enemy.dr || 0) - (G.turn.lowerDR || 0), 0, 0.9 );
    const reduced = Math.round( dmg * (1 - dr) );
    G.enemy.hp = clamp(G.enemy.hp - reduced, 0, G.enemy.hpMax);
    L(`Resolve ‚Üí Gravegrit ${Math.round(G.turn.grit)} √ó (1+${G.turn.oath.toFixed(2)}) = ${dmg} ‚Üí after DR ${reduced}`);
    // Boss passive
    if(G.enemy.onResolveHex){ L('Dread Sigil pulses. The air sours.'); G.turn.grit += 10; }
    // Gilded Jaw passive
    G.dice.forEach(d=>{ if(d.effect?.type==='teeth_on_resolve'){ G.teeth += d.effect.v; } });
    endHand(true);
    checkBeastEnd();
  }

  function endHand(fromResolve=false){
    G.hands = Math.max(0, G.hands - 1);
    G.energy = G.baseEnergy;
    G.turn={grit:0,oath:0,rerolls:1,tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0};
    while(G.hand.length){ G.discard.push(G.hand.pop()); }
    drawCards(3);
    refs.btnResolve.disabled=true;
    updateUI();
  }

  function playCard(i){
    const name=G.hand[i]; const def=CARD_DB[name];
    if(G.energy<def.cost) return;
    G.energy-=def.cost;
    def.play(G);
    const [c]=G.hand.splice(i,1); G.discard.push(c);
    updateUI(); renderHand();
  }

  function addEchoDie(){
    if(G.dice.length>=6){ L('Your hands cannot carry more dice.'); return; }
    const echo = clone(DICE_POOL.find(d=>d.echo) || DICE_POOL[DICE_POOL.length-1]);
    G.dice.push(echo);
    renderDice();
    L('An Echo Die answers your call.');
  }

  // ===== Shops =====
  function grantTeethForVictory(){
    const reward = TEETH_REWARD[G.beastIndex] || 10;
    G.teeth += reward; L(`You wrench ${reward} Teeth from the fallen ${G.enemy.name}.`);
  }

  function showShop(){
    // Build shop items
    refs.shopChoices.innerHTML='';
    const diceChoices = sampleDice(3);
    const singleCardChoices = sampleCards(3);
    const packChoices = sampleCards(3);

    // Dice Bag (choose 1 of 3)
    const diceDiv = document.createElement('div'); diceDiv.className='choice';
    diceDiv.innerHTML = `<div class="row"><div><b>Dice Bag</b><div class="stat">Pick 1 of 3 random dice</div></div><div class="price">${SHOP.diceBagCost} ü¶∑</div></div>`;
    const diceRow = document.createElement('div'); diceRow.className='row'; diceRow.style.marginTop='6px';
    diceChoices.forEach(d=>{
      const b=document.createElement('button'); b.className='btn'; b.innerHTML=`${d.name} <span class="rar ${d.affix}">${labelRarity(d.affix)}</span>`;
      b.addEventListener('click',()=>{
        if(G.teeth<SHOP.diceBagCost){ alert('Not enough Teeth'); return; }
        if(G.caveDiceBagsBought>=SHOP.perCaveDiceBagLimit){ alert('You already bought a Dice Bag this cave.'); return; }
        G.teeth -= SHOP.diceBagCost; G.dice.push(clone(d)); G.caveDiceBagsBought++; updateUI(); renderDice(); L(`Took ${d.name}.`);
      });
      diceRow.appendChild(b);
    });
    diceDiv.appendChild(diceRow);
    refs.shopChoices.appendChild(diceDiv);

    // Single Card (pick 1 of 3)
    const singleDiv = document.createElement('div'); singleDiv.className='choice';
    singleDiv.innerHTML = `<div class="row"><div><b>Choose a Card</b><div class="stat">Pick 1 of 3</div></div><div class="price">${SHOP.singleCardCost} ü¶∑</div></div>`;
    const singleRow = document.createElement('div'); singleRow.className='row'; singleRow.style.marginTop='6px';
    singleCardChoices.forEach(n=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent = n;
      b.addEventListener('click',()=>{
        if(G.teeth<SHOP.singleCardCost){ alert('Not enough Teeth'); return; }
        G.teeth -= SHOP.singleCardCost; G.discard.push(n); updateUI(); L(`Added ${n} to your deck.`);
      });
      singleRow.appendChild(b);
    });
    singleDiv.appendChild(singleRow);
    refs.shopChoices.appendChild(singleDiv);

    // Card Pack (3 random, keep all)
    const packDiv = document.createElement('div'); packDiv.className='choice';
    packDiv.innerHTML = `<div class="row"><div><b>Card Pack</b><div class="stat">Gain all 3</div></div><div class="price">${SHOP.cardPackCost} ü¶∑</div></div>`;
    const packRow = document.createElement('div'); packRow.className='row'; packRow.style.marginTop='6px';
    packChoices.forEach(n=>{
      const tag=document.createElement('span'); tag.className='pill'; tag.textContent=n; packRow.appendChild(tag);
    });
    const buyBtn=document.createElement('button'); buyBtn.className='btn'; buyBtn.textContent='Buy Pack';
    buyBtn.addEventListener('click',()=>{
      if(G.teeth<SHOP.cardPackCost){ alert('Not enough Teeth'); return; }
      G.teeth -= SHOP.cardPackCost; packChoices.forEach(n=> G.discard.push(n)); updateUI(); L(`Packed ${packChoices.join(', ')} into your deck.`);
    });
    packDiv.appendChild(packRow); packDiv.appendChild(buyBtn);
    refs.shopChoices.appendChild(packDiv);

    refs.shop.style.display='flex';
  }
  function hideShop(){ refs.shop.style.display='none'; }

  function sampleDice(n){
    // weighted by rarity: common 40, uncommon 30, rare 20, mythic 8, echo 2
    const weight = d=> d.affix==='common'?40 : d.affix==='uncommon'?30 : d.affix==='rare'?20 : d.affix==='mythic'?8 : d.affix==='echo'?2 : 10;
    const bag=[]; DICE_POOL.forEach(d=>{ for(let i=0;i<weight(d);i++) bag.push(d); });
    const out=[]; while(out.length<n){ const cand = bag[R(bag.length)]; if(!out.includes(cand)) out.push(cand); }
    return out;
  }
  function sampleCards(n){
    const names = Object.keys(CARD_DB);
    const out=[]; while(out.length<n){ const cand = pick(names); if(!out.includes(cand)) out.push(cand); }
    return out;
  }

  // ===== Progression =====
  function checkBeastEnd(){
    if(G.enemy.hp<=0){
      L(`‚Äî ${G.enemy.name} felled. ‚Äî`);
      grantTeethForVictory();
      // Shop after Beast 1 and Beast 2
      if(G.beastIndex<2){
        showShop();
      } else {
        // Next Cave
        G.beastIndex=0; G.cave++; G.caveDiceBagsBought=0;
        startBeast();
      }
    } else if(G.hands<=0){
      alert('Out of hands! The beast endures. You regroup.');
      startBeast();
    }
  }

  // ===== Wire Buttons =====
  $('btnNew').addEventListener('click', newRun);
  $('btnRoll').addEventListener('click', rollDice);
  $('btnResolve').addEventListener('click', resolveHand);
  $('btnEndHand').addEventListener('click', ()=> endHand(false));
  $('btnAddEcho').addEventListener('click', addEchoDie);
  refs.btnSkipShop.addEventListener('click', ()=>{
    hideShop();
    // advance to next beast
    G.beastIndex++; startBeast();
  });

  // ===== Boot =====
  newRun();
  </script>
</body>
</html>
