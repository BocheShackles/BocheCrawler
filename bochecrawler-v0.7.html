<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>BocheCrawler v0.7 â€” Dice Cap + Sell + Manage</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{--bg:#0b0b0c; --panel:#121215; --ink:#e7e3da; --muted:#a7a39a; --accent:#d84f4f; --gold:#c09b43; --good:#58c97c; --bad:#d45b5b; --blue:#4fa3d8; --vio:#b79cff;}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 700px at 50% -200px,#15151a,#0b0b0c);color:var(--ink);font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;display:flex; align-items:center; justify-content:center;}
#game{width:100%; max-width:600px; height:100svh; background:linear-gradient(180deg,#0b0b0c 0%, #0e0e10 40%, #111116 100%);border:1px solid #222; border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.6); overflow-y:auto; -webkit-overflow-scrolling:touch; position:relative}
.topbar{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0f0f12; border-bottom:1px solid #1f1f24; position:sticky; top:0; z-index:5}
.title{font-weight:800; letter-spacing:.2px; font-size:14px}
.pill{padding:3px 6px; border:1px solid #333; border-radius:999px; font-size:11px; color:var(--muted)}
.btn{background:#1a1a20;color:var(--ink);border:1px solid #2a2a33;padding:8px 10px;border-radius:12px;font-weight:700;font-size:12px;cursor:pointer}
.btn:disabled{opacity:.55;cursor:not-allowed}
.arena{display:grid; grid-template-rows: 168px auto auto; gap:10px; padding:10px 12px}
.stage{display:grid; grid-template-columns: 1fr; gap:8px; background:#0e0e12; border:1px solid #24242a; border-radius:16px; padding:10px}
.stageTop{display:flex; align-items:center; justify-content:space-between}
.enemyBox{display:flex; align-items:center; gap:10px}
.sprite{height:96px; width:96px; border-radius:10px; background:repeating-linear-gradient(90deg,#120c0c 0 4px,#150e0e 4px 8px); border:1px solid #23232b; display:flex; align-items:center; justify-content:center; font-size:32px; position:relative}
.hpWrap{flex:1}
.hpbar{position:relative; height:14px; background:#1a1a20; border:1px solid #2a2a33; border-radius:999px; overflow:hidden}
.hpfill{position:absolute; inset:0; width:100%; background:linear-gradient(90deg, #e87070, #b14040)}
.hud{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.stat{font-size:12px; color:var(--muted)}
.panel{background:var(--panel); border:1px solid #24242a; border-radius:16px; padding:10px}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px}
.col{display:flex; flex-direction:column; gap:8px}
.jokers{display:flex; gap:10px; overflow-x:auto; padding:8px 6px; background:#101015; border-radius:12px; scroll-snap-type:x mandatory}
.joker{width:160px; flex:0 0 auto; background:#141419; border:1px solid #2a2a33; border-radius:14px; padding:10px; scroll-snap-align:start; position:relative}
.joker h4{margin:0 0 2px 0; font-size:12px; color:var(--muted)}
.pip{font-size:26px; font-weight:800}
.meta{font-size:11px; color:var(--muted')}
.badge{position:absolute; top:8px; right:8px; font-size:10px; padding:3px 6px; border-radius:999px; border:1px solid #444; background:#1b1b22; color:#ffd166; font-weight:800}
.rar{font-weight:800}
.rar.common{color:#bbb}
.rar.uncommon{color:#79b7f2}
.rar.rare{color:var(--vio)}
.rar.mythic{color:#ffd166}
.rar.echo{color:#ffd166}
.handWrap{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
.hand{display:flex; gap:8px; overflow-x:auto; padding:6px 4px; min-height:98px}
.card{min-width:160px; background:#141419; border:1px solid #2a2a33; border-radius:14px; padding:10px; text-align:left}
.card .name{font-weight:700; font-size:13px}
.card .desc{font-size:11px; color:var(--muted)}
.log{max-height:160px; overflow:auto; font-size:12px; line-height:1.35; color:var(--muted); border-top:1px dashed #2a2a33; padding-top:6px}
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding:16px; z-index:20}
.modal{background:#131318; border:1px solid #2a2a33; border-radius:16px; width:100%; max-width:520px; padding:12px}
.modal h3{margin:0 0 6px 0}
.choices{display:grid; grid-template-columns:1fr; gap:8px}
.choice{background:#15151b; border:1px solid #2a2a33; border-radius:12px; padding:10px; text-align:left}
.choice .row{align-items:start}
.price{font-weight:800}
.teethPop{position:absolute; transform:translate(-50%,-50%); left:50%; top:50%; font-weight:800; text-shadow:0 2px 8px rgba(0,0,0,.6); pointer-events:none; animation:teethFloat .8s ease forwards}
@keyframes teethFloat { 0%{opacity:0; transform:translate(-50%,-30%) scale(.9)} 20%{opacity:1} 100%{opacity:0; transform:translate(-50%,-90%) scale(1.1)} }
.popAnim{animation:pop .25s ease}
@keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
</style>
</head>
<body>
<div id="game">
  <div class="topbar">
    <div class="title">BocheCrawler v0.7 â€” Caves & Beasts</div>
    <div class="hud">
      <span class="pill">Cave <b id="cave">1</b></span>
      <span class="pill">Beast <b id="beast">1/3</b></span>
      <span class="pill" id="teethPill">Teeth ðŸ¦· <b id="teeth">0</b></span>
      <span class="pill">Hands <b id="hands">4</b></span>
      <span class="pill">Energy <b id="energy">3</b></span>
      <button class="btn" id="btnManage">Manage Dice</button>
      <button class="btn" id="btnNew">New Run</button>
    </div>
  </div>

  <div class="arena">
    <div class="stage">
      <div class="stageTop">
        <div class="enemyBox">
          <div class="sprite" id="enemySprite">ðŸ©¸</div>
          <div class="hpWrap">
            <div class="row" style="margin-bottom:4px">
              <div class="stat"><b id="enemyName">Scout Beast</b></div>
              <div class="stat">Omen: <b id="beastMod">â€”</b></div>
            </div>
            <div class="hpbar"><div class="hpfill" id="enemyHPFill"></div></div>
            <div class="stat">HP <b id="enemyHP">50</b> / <b id="enemyHPMax">50</b></div>
          </div>
        </div>
        <div class="col">
          <div class="stat">Gravegrit: <b id="grit">0</b> â€¢ Oathfire: <b id="oath">0</b>x</div>
          <div class="row">
            <button class="btn" id="btnRoll">Roll</button>
            <button class="btn" id="btnResolve" disabled>Resolve</button>
            <button class="btn" id="btnEndHand" disabled>End Hand</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="margin-bottom:6px">
        <div class="stat">Dice (Jokers) â€” <span id="diceCountInfo"></span></div>
        <div class="stat">Rerolls <b id="rerolls">1</b></div>
      </div>
      <div class="jokers" id="diceTray"></div>
    </div>

    <div class="panel">
      <div class="handWrap">
        <div class="stat">Hand</div>
        <div class="stat">Draw pile <b id="drawCount">0</b></div>
      </div>
      <div class="hand" id="hand"></div>
      <div class="log" id="log"></div>
    </div>
  </div>
</div>

<!-- Shop modal -->
<div class="overlay" id="shop">
  <div class="modal">
    <h3>Burrow-Market</h3>
    <div class="stat">Spend your <b>Teeth</b> to grow stronger.</div>
    <div class="choices" id="shopChoices"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSkipShop">Leave</button>
    </div>
  </div>
</div>

<!-- Post-shop preview -->
<div class="overlay" id="preview">
  <div class="modal">
    <h3>Loadout Preview</h3>
    <div id="previewBody" class="choices"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnPreviewContinue">Continue</button>
    </div>
  </div>
</div>

<!-- Sell modal -->
<div class="overlay" id="sell">
  <div class="modal">
    <h3>Sell a Die to Make Space</h3>
    <div class="stat">Select a die to sell. Youâ€™ll receive Teeth based on rarity (+4 if Echo).</div>
    <div class="choices" id="sellChoices"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCancelSell">Cancel</button>
    </div>
  </div>
</div>

<!-- Manage Dice -->
<div class="overlay" id="manage">
  <div class="modal">
    <h3>Manage Dice</h3>
    <div class="stat">Tap a die below to sell it immediately.</div>
    <div class="choices" id="manageChoices"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCloseManage">Close</button>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const L = (m)=>{ const p=document.createElement('p'); p.textContent=m; $('log').prepend(p); };
const R = (n)=>Math.floor(Math.random()*n);
const pick = (a)=>a[R(a.length)];
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function clone(x){ return JSON.parse(JSON.stringify(x)); }

const FACE = { SWORD:{k:'SWORD', i:'âš”ï¸'}, SHIELD:{k:'SHIELD', i:'ðŸ›¡ï¸'}, EYE:{k:'EYE', i:'ðŸ‘ï¸'}, HEX:{k:'HEX', i:'â˜ ï¸'}, WILD:{k:'WILD', i:'â­'} };
const RAR = { COMMON:'common', UNCOMMON:'uncommon', RARE:'rare', MYTHIC:'mythic', ECHO:'echo' };

const DICE_POOL = [
  {name:'Initiate Die', faces:[FACE.SWORD,FACE.SWORD,FACE.SHIELD,FACE.EYE,FACE.WILD,FACE.SHIELD], power:1, affix:RAR.COMMON, echo:false, effect:{type:'fury_per_eye', v:0.25}},
  {name:'Stitched Cube', faces:[FACE.SWORD,FACE.SHIELD,FACE.SHIELD,FACE.EYE,FACE.SWORD,FACE.SHIELD], power:1, affix:RAR.COMMON, echo:false, effect:{type:'flat_grit', v:6}},
  {name:'Omen-Carved', faces:[FACE.SWORD,FACE.SWORD,FACE.HEX,FACE.SWORD,FACE.EYE,FACE.HEX], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'grit_on_hex', v:8}},
  {name:'Blessed Cube', faces:[FACE.SWORD,FACE.WILD,FACE.SHIELD,FACE.EYE,FACE.SWORD,FACE.SHIELD], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'flat_fury', v:0.2}},
  {name:'Rot Die', faces:[FACE.HEX,FACE.SWORD,FACE.HEX,FACE.SHIELD,FACE.EYE,FACE.HEX], power:1, affix:RAR.UNCOMMON, echo:false, effect:{type:'reduce_maxhp_on_hex', v:5}},
  {name:'Bone Fracture', faces:[FACE.SWORD,FACE.SWORD,FACE.SWORD,FACE.EYE,FACE.WILD,FACE.SHIELD], power:2, affix:RAR.RARE, echo:false, effect:{type:'fury_per_sword', v:0.4}},
  {name:'Gilded Jaw', faces:[FACE.SWORD,FACE.EYE,FACE.SHIELD,FACE.SWORD,FACE.WILD,FACE.SHIELD], power:2, affix:RAR.RARE, echo:false, effect:{type:'teeth_on_resolve', v:2}},
  {name:'Hollow Face', faces:[FACE.WILD,FACE.SWORD,FACE.WILD,FACE.SWORD,FACE.WILD,FACE.SWORD], power:3, affix:RAR.MYTHIC, echo:false, effect:{type:'sword_amp_but_hand_penalty', v:0.5}},
  {name:'Wraith Echo', faces:[FACE.WILD,FACE.SWORD,FACE.EYE,FACE.HEX,FACE.WILD,FACE.SWORD], power:2, affix:RAR.ECHO, echo:true, effect:{type:'fury_per_wild', v:0.5}},
];

const CARD_DB = {
  'Bone Toss': {cost:1, text:'+10 Gravegrit, draw 1', play:G=>{G.turn.grit+=10; G.turn.drawNext=1;}},
  'Mire Shield': {cost:1, text:'+15 Gravegrit & lower enemy DR by 10% this hand', play:G=>{G.turn.grit+=15; G.turn.lowerDR=0.10;}},
  'Lunge': {cost:1, text:'+20 Gravegrit', play:G=>{G.turn.grit+=20;}},
  'Guard': {cost:1, text:'+10 Gravegrit & +1 reroll', play:G=>{G.turn.grit+=10; G.turn.rerolls++;}},
  'Hex Canticle': {cost:1, text:'Tag HEX (synergy with â˜ ï¸)', play:G=>{G.turn.tags.add('HEX_TAG');}},
  'Focus': {cost:1, text:'+0.3 Oathfire', play:G=>{G.turn.oath+=0.3;}},
  'Convert': {cost:1, text:'Turn one ðŸ›¡ï¸ to âš”ï¸ this hand', play:G=>{const d=G.dice.find(d=>d.current && d.current.k==='SHIELD'); if(d){ d.current=FACE.SWORD; L('A shield becomes a blade.'); }}},
  'Oathbound Strike': {cost:1, text:'+20 Gravegrit; double Fury from dice this hand', play:G=>{G.turn.grit+=20; G.turn.doubleFury=true;}},
  'Bone Storm': {cost:2, text:'+40 Gravegrit, draw 2', play:G=>{G.turn.grit+=40; G.turn.drawNext=2;}},
  'Oathforge': {cost:2, text:'+1.0 Oathfire', play:G=>{G.turn.oath+=1.0;}},
  'Hex Ritual': {cost:2, text:'Add HEX tag and +20 Gravegrit', play:G=>{G.turn.tags.add('HEX_TAG'); G.turn.grit+=20;}},
  'Blood Oath': {cost:3, text:'+1.5 Oathfire and +40 Gravegrit', play:G=>{G.turn.oath+=1.5; G.turn.grit+=40;}},
  'Dirge of the Pit': {cost:3, text:'Set Oathfire to at least 2.0 and +30 Gravegrit', play:G=>{G.turn.oath = Math.max(G.turn.oath, 2.0); G.turn.grit+=30;}}
};
function starterDeck(){ return ['Lunge','Lunge','Lunge','Guard','Guard','Hex Canticle','Focus','Convert','Bone Toss','Mire Shield']; }

const BEASTS=[
  {name:'Scout Beast', omen:'None', hp:(c)=> 40 + (c-1)*20},
  {name:'Mire Beast', omen:'Thick Hide (+10% DR)', hp:(c)=> 65 + (c-1)*30, rule:(G)=>{G.enemy.dr=0.10;}},
  {name:'Crypt Lord', omen:'Dread Sigil (+Hex burden per resolve)', hp:(c)=> 90 + (c-1)*45, rule:(G)=>{G.enemy.onResolveHex=1;}},
];
const ENEMY_SPRITES=['ðŸ©¸','ðŸ¦´','ðŸº','ðŸ•¯ï¸','ðŸ—¡ï¸','ðŸ•·ï¸'];

const SHOP = { cardPackCost:12, singleCardCost:6, diceBagCost:20, perCaveDiceBagLimit:1, echoChance:0.18 };
const TEETH_REWARD = [8, 12, 20];

const G = {
  cave:1, beastIndex:0,
  handsMax:4, hands:4,
  teeth:0,
  energy:3, baseEnergy:3,
  dice:[], hand:[], draw:[], discard:[],
  enemy:{name:'', hp:0, hpMax:0, dr:0, onResolveHex:0, sprite:'ðŸ©¸'},
  turn:{grit:0, oath:0, rerolls:1, tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0},
  caveDiceBagsBought:0,
  pendingPurchase:null
};

const refs={
  cave:$('cave'), beast:$('beast'), hands:$('hands'), teeth:$('teeth'), energy:$('energy'), teethPill:$('teethPill'),
  enemySprite:$('enemySprite'), enemyName:$('enemyName'), beastMod:$('beastMod'),
  enemyHP:$('enemyHP'), enemyHPMax:$('enemyHPMax'), enemyHPFill:$('enemyHPFill'),
  diceTray:$('diceTray'), hand:$('hand'), drawCount:$('drawCount'), diceCountInfo:$('diceCountInfo'),
  grit:$('grit'), oath:$('oath'), rerolls:$('rerolls'),
  btnRoll:$('btnRoll'), btnResolve:$('btnResolve'), btnEndHand:$('btnEndHand'),
  shop:$('shop'), shopChoices:$('shopChoices'), btnSkipShop:$('btnSkipShop'),
  preview:$('preview'), previewBody:$('previewBody'), btnPreviewContinue:$('btnPreviewContinue'),
  sell:$('sell'), sellChoices:$('sellChoices'), btnCancelSell:$('btnCancelSell'),
  manage:$('manage'), manageChoices:$('manageChoices'), btnCloseManage:$('btnCloseManage'),
  btnManage:$('btnManage'), btnNew:$('btnNew')
};

function newRun(){
  G.cave=1; G.beastIndex=0; G.handsMax=4; G.energy=G.baseEnergy=3; G.teeth=0; G.caveDiceBagsBought=0;
  G.dice=[ clone(pickByRarity(['common','uncommon'])), clone(pickByRarity(['common'])), clone(pickByRarity(['uncommon'])) ];
  G.draw=shuffle(starterDeck()); G.discard=[]; G.hand=[];
  startBeast();
  L('â€” New run. The cave yawns open. â€”');
}
function startBeast(){
  G.hands=G.handsMax;
  const b=BEASTS[G.beastIndex];
  const hp=b.hp(G.cave);
  Object.assign(G.enemy,{name:b.name, hp:hp, hpMax:hp, dr:0, onResolveHex:0, sprite:pick(ENEMY_SPRITES)});
  if(b.rule) b.rule(G);
  G.turn={grit:0,oath:0,rerolls:1,tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0};
  updateUI();
  drawCards(3);
  renderDice();
  L(`â€” ${b.name} (Cave ${G.cave}) â€” ${b.omen}`);
}

function nonEchoCount(){ return G.dice.filter(d=>!d.echo).length; }
function diceCap(){ return 4; }

function updateUI(){
  refs.cave.textContent=G.cave;
  refs.beast.textContent=(G.beastIndex+1)+'/3';
  refs.hands.textContent=G.hands;
  refs.teeth.textContent=G.teeth;
  refs.energy.textContent=G.energy;
  refs.rerolls.textContent=G.turn.rerolls;
  $('grit').textContent=Math.round(G.turn.grit);
  $('oath').textContent=(G.turn.oath).toFixed(2);
  refs.enemyName.textContent=G.enemy.name;
  refs.enemyHP.textContent=G.enemy.hp; refs.enemyHPMax.textContent=G.enemy.hpMax;
  refs.enemyHPFill.style.width=(G.enemy.hp/G.enemy.hpMax*100)+'%';
  refs.enemySprite.textContent=G.enemy.sprite;
  refs.beastMod.textContent=BEASTS[G.beastIndex].omen;
  refs.drawCount.textContent=G.draw.length;
  refs.diceCountInfo.textContent = `Nonâ€‘Echo: ${nonEchoCount()}/${diceCap()} â€¢ Total: ${G.dice.length}`;
}

function pickByRarity(allowed){
  const pool = DICE_POOL.filter(d=>allowed.includes(d.affix));
  return pick(pool);
}
function labelRarity(r){ return r.charAt(0).toUpperCase()+r.slice(1); }
function effectText(d){
  const e=d.effect||{};
  const map={
    'fury_per_eye':`+${e.v} Oathfire per ðŸ‘ï¸`,
    'fury_per_wild':`+${e.v} Oathfire per â­`,
    'flat_fury':`+${e.v} Oathfire`,
    'fury_per_sword':`+${e.v} Oathfire per âš”ï¸`,
    'flat_grit':`+${e.v} Gravegrit`,
    'grit_on_hex':`+${e.v} Gravegrit on â˜ ï¸/HEX`,
    'reduce_maxhp_on_hex':`- ${e.v} enemy max HP on â˜ ï¸`,
    'sword_amp_but_hand_penalty':`âš”ï¸ amp +${Math.round(e.v*100)}% (with cost)`,
    'teeth_on_resolve':`+${e.v} Teeth on resolve`
  };
  return map[e.type]||e.type||'â€”';
}

function renderDice(){
  refs.diceTray.innerHTML='';
  G.dice.forEach((d,idx)=>{
    const el=document.createElement('div'); el.className='joker'; el.dataset.idx=idx;
    const h4=document.createElement('h4'); h4.innerHTML=`${d.name} <span class="rar ${d.affix}">${labelRarity(d.affix)}</span>`; el.appendChild(h4);
    const face=document.createElement('div'); face.className='pip'; face.textContent=d.current?d.current.i:'â€”'; el.appendChild(face);
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent = effectText(d); el.appendChild(meta);
    if(d.echo){ const b=document.createElement('div'); b.className='badge'; b.textContent='ECHO'; el.appendChild(b); }
    refs.diceTray.appendChild(el);
  });
  updateUI();
}

function renderHand(){
  refs.hand.innerHTML='';
  if(!G.hand.length){ const tip=document.createElement('div'); tip.className='stat'; tip.style.padding='4px'; tip.textContent='(No cards in hand)'; refs.hand.appendChild(tip); return; }
  G.hand.forEach((name,i)=>{
    const def=CARD_DB[name];
    const btn=document.createElement('button'); btn.className='card';
    btn.innerHTML=`<div class="name">${name} <span class="pill">${def.cost}</span></div><div class="desc">${def.text}</div>`;
    btn.disabled=(G.energy<def.cost);
    btn.addEventListener('click',()=> playCard(i));
    refs.hand.appendChild(btn);
  });
}

function drawCards(n){
  for(let i=0;i<n;i++){
    if(G.draw.length===0){ G.draw=shuffle(G.discard); G.discard=[]; }
    if(G.draw.length===0) break;
    G.hand.push(G.draw.pop());
    if(G.turn.drawNext>0){ G.turn.drawNext--; }
  }
  updateUI(); renderHand();
}

function teethPop(amount){
  const el=document.createElement('div');
  el.className='teethPop';
  el.style.color = amount>=0 ? '#8fff8f' : '#ff9f9f';
  el.textContent = (amount>=0?'+':'')+amount+' ðŸ¦·';
  $('teethPill').classList.add('popAnim');
  setTimeout(()=>$('teethPill').classList.remove('popAnim'), 250);
  document.getElementById('game').appendChild(el);
  setTimeout(()=>el.remove(),800);
}
function addTeeth(n){ G.teeth += n; teethPop(n); updateUI(); }

function rollDice(){
  if(G.turn.rerolls<=0){ L('No rerolls left.'); return; }
  let turnFuryBonus=0, turnGritBonus=0;
  G.dice.forEach(d=>{
    const idx=R(d.faces.length); d.current=d.faces[idx];
    if(d.effect?.type==='fury_per_eye' && d.current.k==='EYE'){ turnFuryBonus += d.effect.v; }
    if(d.effect?.type==='fury_per_wild' && d.current.k==='WILD'){ turnFuryBonus += d.effect.v; }
    if(d.effect?.type==='flat_fury'){ turnFuryBonus += d.effect.v; }
    if(d.effect?.type==='fury_per_sword' && d.current.k==='SWORD'){ turnFuryBonus += d.effect.v; }
    if(d.effect?.type==='flat_grit'){ turnGritBonus += d.effect.v; }
    if(d.effect?.type==='grit_on_hex' && (d.current.k==='HEX' || G.turn.tags.has('HEX_TAG')) ){ turnGritBonus += d.effect.v; }
    if(d.effect?.type==='reduce_maxhp_on_hex' && d.current.k==='HEX'){ G.enemy.hpMax = Math.max(1, G.enemy.hpMax - d.effect.v); G.enemy.hp = Math.min(G.enemy.hp, G.enemy.hpMax); }
    if(d.effect?.type==='sword_amp_but_hand_penalty' && d.current.k==='SWORD'){ turnGritBonus += Math.round( (G.turn.grit+turnGritBonus) * d.effect.v ); }
  });
  G.turn.oath += (G.turn.doubleFury? turnFuryBonus*2 : turnFuryBonus);
  G.turn.grit += turnGritBonus;
  G.turn.rerolls--;
  $('btnResolve').disabled=false;
  updateUI(); renderDice();
  L(`You roll. +${Math.round(turnGritBonus)} Gravegrit, +${turnFuryBonus.toFixed(2)} Oathfire.`);
}

function resolveHand(){
  const mult = 1 + G.turn.oath;
  let dmg = Math.round( G.turn.grit * mult );
  const dr = clamp( (G.enemy.dr || 0) - (G.turn.lowerDR || 0), 0, 0.9 );
  const reduced = Math.round( dmg * (1 - dr) );
  G.enemy.hp = clamp(G.enemy.hp - reduced, 0, G.enemy.hpMax);
  L(`Resolve â†’ Gravegrit ${Math.round(G.turn.grit)} Ã— (1+${G.turn.oath.toFixed(2)}) = ${dmg} â†’ after DR ${reduced}`);
  if(G.enemy.onResolveHex){ L('Dread Sigil pulses. The air sours.'); G.turn.grit += 10; }
  G.dice.forEach(d=>{ if(d.effect?.type==='teeth_on_resolve'){ addTeeth(d.effect.v); } });
  endHand();
  checkBeastEnd();
}

function endHand(){
  G.hands = Math.max(0, G.hands - 1);
  G.energy = G.baseEnergy;
  G.turn={grit:0,oath:0,rerolls:1,tags:new Set(), drawNext:0, doubleFury:false, lowerDR:0};
  while(G.hand.length){ G.discard.push(G.hand.pop()); }
  drawCards(3);
  $('btnResolve').disabled=true;
  updateUI();
}

function playCard(i){
  const name=G.hand[i]; const def=CARD_DB[name];
  if(G.energy<def.cost) return;
  G.energy-=def.cost;
  def.play(G);
  const [c]=G.hand.splice(i,1); G.discard.push(c);
  updateUI(); renderHand();
}

function sellValue(d){
  const base = d.affix==='common'?4 : d.affix==='uncommon'?6 : d.affix==='rare'?10 : d.affix==='mythic'?16 : 8;
  return base + (d.echo?4:0);
}
function openSellModal(onSold){
  $('sellChoices').innerHTML='';
  G.dice.forEach((d,idx)=>{
    const ch=document.createElement('div'); ch.className='choice';
    ch.innerHTML = `<div class="row"><div><b>${d.name}</b> <span class="rar ${d.affix}">${labelRarity(d.affix)}</span>${d.echo? ' <span class="pill">ECHO</span>':''}<div class="stat">${effectText(d)}</div></div><div class="price">Sell: ${sellValue(d)} ðŸ¦·</div></div>`;
    ch.addEventListener('click',()=>{
      addTeeth(sellValue(d));
      G.dice.splice(idx,1);
      renderDice();
      $('sell').style.display='none';
      if(onSold) onSold();
    });
    $('sellChoices').appendChild(ch);
  });
  $('sell').style.display='flex';
}
function openManage(){
  $('manageChoices').innerHTML='';
  G.dice.forEach((d,idx)=>{
    const ch=document.createElement('div'); ch.className='choice';
    ch.innerHTML = `<div class="row"><div><b>${d.name}</b> <span class="rar ${d.affix}">${labelRarity(d.affix)}</span>${d.echo? ' <span class="pill">ECHO</span>':''}<div class="stat">${effectText(d)}</div></div><div class="price">Sell: ${sellValue(d)} ðŸ¦·</div></div>`;
    ch.addEventListener('click',()=>{
      if(!confirm('Sell this die?')) return;
      addTeeth(sellValue(d)); G.dice.splice(idx,1); renderDice(); openManage();
    });
    $('manageChoices').appendChild(ch);
  });
  $('manage').style.display='flex';
}

function grantTeethForVictory(){
  const reward = TEETH_REWARD[G.beastIndex] || 10;
  addTeeth(reward);
  L(`You wrench ${reward} Teeth from the fallen ${G.enemy.name}.`);
}
function sampleDice(n){
  const weight = d=> d.affix==='common'?40 : d.affix==='uncommon'?30 : d.affix==='rare'?20 : d.affix==='mythic'?8 : d.affix==='echo'?6 : 10;
  const bag=[]; DICE_POOL.forEach(d=>{ for(let i=0;i<weight(d);i++) bag.push(d); });
  const out=[]; while(out.length<n){ const cand = clone(bag[R(bag.length)]);
    if(!cand.echo && Math.random()<SHOP.echoChance){ cand.echo=true; cand._overlayEcho=true; }
    out.push(cand);
    if(out.length>8) break;
  }
  return out;
}
function sampleCards(n){
  const names = Object.keys(CARD_DB);
  const out=[]; while(out.length<n){ const cand = pick(names); if(!out.includes(cand)) out.push(cand); }
  return out;
}

function showShop(){
  $('shopChoices').innerHTML='';
  const diceChoices = sampleDice(3);
  const singleCardChoices = sampleCards(3);
  const packChoices = sampleCards(3);

  const diceDiv = document.createElement('div'); diceDiv.className='choice';
  diceDiv.innerHTML = `<div class="row"><div><b>Dice Bag</b><div class="stat">Pick 1 of 3 random dice (Echo can appear)</div></div><div class="price">${SHOP.diceBagCost} ðŸ¦·</div></div>`;
  const diceRow = document.createElement('div'); diceRow.className='row'; diceRow.style.marginTop='6px'; diceRow.style.flexWrap='wrap';
  diceChoices.forEach(d=>{
    const b=document.createElement('button'); b.className='btn'; b.innerHTML=`${d.name} <span class="rar ${d.affix}">${labelRarity(d.affix)}</span> ${d.echo?'<span class="pill">ECHO</span>':''}<div class="stat">${effectText(d)}</div>`;
    b.style.textAlign='left';
    b.addEventListener('click',()=>{
      if(G.teeth<SHOP.diceBagCost){ alert('Not enough Teeth'); return; }
      function finishPurchase(){
        addTeeth(-SHOP.diceBagCost);
        G.dice.push(clone(d));
        renderDice(); L(\`Took ${d.name}\${d.echo?' (Echo)':''}.\`);
      }
      if(!d.echo && nonEchoCount()>=4){
        G.pendingPurchase = d;
        openSellModal(()=>{ G.pendingPurchase=null; finishPurchase(); });
      } else {
        finishPurchase();
      }
    });
    diceRow.appendChild(b);
  });
  diceDiv.appendChild(diceRow);
  $('shopChoices').appendChild(diceDiv);

  const singleDiv = document.createElement('div'); singleDiv.className='choice';
  singleDiv.innerHTML = `<div class="row"><div><b>Choose a Card</b><div class="stat">Pick 1 of 3</div></div><div class="price">${SHOP.singleCardCost} ðŸ¦·</div></div>`;
  const singleRow = document.createElement('div'); singleRow.className='row'; singleRow.style.marginTop='6px';
  singleCardChoices.forEach(n=>{
    const b=document.createElement('button'); b.className='btn'; b.textContent = n;
    b.addEventListener('click',()=>{
      if(G.teeth<SHOP.singleCardCost){ alert('Not enough Teeth'); return; }
      addTeeth(-SHOP.singleCardCost); G.discard.push(n); updateUI(); L(\`Added ${n} to your deck.\`);
    });
    singleRow.appendChild(b);
  });
  singleDiv.appendChild(singleRow);
  $('shopChoices').appendChild(singleDiv);

  const packDiv = document.createElement('div'); packDiv.className='choice';
  packDiv.innerHTML = `<div class="row"><div><b>Card Pack</b><div class="stat">Gain all 3</div></div><div class="price">${SHOP.cardPackCost} ðŸ¦·</div></div>`;
  const packRow = document.createElement('div'); packRow.className='row'; packRow.style.marginTop='6px';
  packChoices.forEach(n=>{ const tag=document.createElement('span'); tag.className='pill'; tag.textContent=n; packRow.appendChild(tag); });
  const buyBtn=document.createElement('button'); buyBtn.className='btn'; buyBtn.textContent='Buy Pack';
  buyBtn.addEventListener('click',()=>{
    if(G.teeth<SHOP.cardPackCost){ alert('Not enough Teeth'); return; }
    addTeeth(-SHOP.cardPackCost); packChoices.forEach(n=> G.discard.push(n)); updateUI(); L(\`Packed ${packChoices.join(', ')} into your deck.\`);
  });
  packDiv.appendChild(packRow); packDiv.appendChild(buyBtn);
  $('shopChoices').appendChild(packDiv);

  $('shop').style.display='flex';
}
function hideShop(){ $('shop').style.display='none'; }

function showPreview(){
  $('previewBody').innerHTML='';
  const dSec=document.createElement('div'); dSec.className='choice'; dSec.innerHTML = '<b>Dice</b>';
  G.dice.forEach(d=>{
    const p=document.createElement('div');
    p.innerHTML = `${d.name} <span class="rar ${d.affix}">${labelRarity(d.affix)}</span> ${d.echo?'<span class="pill">ECHO</span>':''} â€” <span class="stat">${effectText(d)}</span>`;
    dSec.appendChild(p);
  });
  const cSec=document.createElement('div'); cSec.className='choice';
  cSec.innerHTML = `<b>Deck</b> <span class="pill">${G.draw.length + G.hand.length + G.discard.length} cards</span>`;
  const sample = (G.draw.concat(G.hand, G.discard)).slice(0,12);
  const list=document.createElement('div'); list.style.display='flex'; list.style.flexWrap='wrap'; list.style.gap='6px'; list.style.marginTop='6px';
  sample.forEach(n=>{ const tag=document.createElement('span'); tag.className='pill'; tag.textContent=n; list.appendChild(tag); });
  cSec.appendChild(list);
  const tSec=document.createElement('div'); tSec.className='choice';
  tSec.innerHTML = `<b>Teeth</b> <span class="pill">ðŸ¦· ${G.teeth}</span>`;
  $('previewBody').appendChild(dSec); $('previewBody').appendChild(cSec); $('previewBody').appendChild(tSec);
  $('preview').style.display='flex';
}

function checkBeastEnd(){
  if(G.enemy.hp<=0){
    L(\`â€” ${G.enemy.name} felled. â€”\`);
    grantTeethForVictory();
    if(G.beastIndex<2){
      showShop();
    } else {
      G.beastIndex=0; G.cave++; G.caveDiceBagsBought=0;
      startBeast();
    }
  } else if(G.hands<=0){
    alert('Out of hands! The beast endures. You regroup.');
    startBeast();
  }
}

$('btnNew').addEventListener('click', newRun);
$('btnRoll').addEventListener('click', rollDice);
$('btnResolve').addEventListener('click', resolveHand);
$('btnEndHand').addEventListener('click', ()=> endHand());
$('btnSkipShop').addEventListener('click', ()=>{ hideShop(); showPreview(); });
$('btnPreviewContinue').addEventListener('click', ()=>{ $('preview').style.display='none'; G.beastIndex++; startBeast(); });
$('btnCancelSell').addEventListener('click', ()=>{ $('sell').style.display='none'; G.pendingPurchase=null; });
$('btnManage').addEventListener('click', openManage);
$('btnCloseManage').addEventListener('click', ()=> $('manage').style.display='none');

newRun();
</script>
</body>
</html>